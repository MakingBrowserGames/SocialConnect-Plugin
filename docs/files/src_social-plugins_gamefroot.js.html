<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\social-plugins\gamefroot.js - SocialConnect</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="SocialConnect"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.8.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Kiwi.Plugins.SocialConnect.html">Kiwi.Plugins.SocialConnect</a></li>
            
                <li><a href="../classes/Kiwi.Plugins.SocialConnect.Base.html">Kiwi.Plugins.SocialConnect.Base</a></li>
            
                <li><a href="../classes/Kiwi.Plugins.SocialConnect.Facebook.html">Kiwi.Plugins.SocialConnect.Facebook</a></li>
            
                <li><a href="../classes/Kiwi.Plugins.SocialConnect.Gamefroot.html">Kiwi.Plugins.SocialConnect.Gamefroot</a></li>
            
                <li><a href="../classes/Kiwi.Plugins.SocialConnect.Manager.html">Kiwi.Plugins.SocialConnect.Manager</a></li>
            
                <li><a href="../classes/Kiwi.Plugins.SocialConnect.Twitter.html">Kiwi.Plugins.SocialConnect.Twitter</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Kiwi.html">Kiwi</a></li>
            
                <li><a href="../modules/Plugins.html">Plugins</a></li>
            
                <li><a href="../modules/SocialConnect.html">SocialConnect</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\social-plugins\gamefroot.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

/**
* Contains the functionality for creating/logging into gamefroot accounts.  
*
* @module Plugins
* @submodule SocialConnect
* @namespace Kiwi.Plugins.SocialConnect
* @class Gamefroot
* @extends Kiwi.Plugins.SocialConnect.Base
* 
*/
Kiwi.Plugins.SocialConnect.Gamefroot = function( game ) {

  Kiwi.Plugins.SocialConnect.Base.call(this, game, &#x27;Gamefroot&#x27;, {
    &#x27;login&#x27;: true,
    &#x27;share&#x27;: false,
    &#x27;init&#x27;: false
  });


  /**
  * Indicates if the api is ready to make a request to the gamefroot servers or not.
  * @property _ready
  * @type Boolean
  * @default true
  * @private
  */
  this._ready = true;


  /**
  * Stores the users information from the last time he logged in. 
  * @property userInfo
  * @type Object
  * @default null
  * @public
  */
  this.userInfo = null; 


  /**
  * The amount of time (in milliseconds) to wait for a response before timing out.
  * @property timeout
  * @type number
  * @default 30000
  * @public
  */
  this.timeout = 30000;


  /**
  * The url of the gamefroot server to use. 
  * See &#x27;Kiwi.Plugins.SocialConnect.Gamefroot.ServerURL&#x27; for options. 
  * @property serverURL
  * @type string
  * @default ServerURL.LIVE
  * @public
  */
  this.serverURL = Kiwi.Plugins.SocialConnect.Gamefroot.ServerURL.LIVE;

};

Kiwi.extend( Kiwi.Plugins.SocialConnect.Gamefroot, Kiwi.Plugins.SocialConnect.Base );


/**
* Namespace which holds the URLs of gamefroot api servers.
* @property ServerURL
* @type Object
* @public
* @static
* @readOnly
*/
Kiwi.Plugins.SocialConnect.Gamefroot.ServerURL = {

  /**
  * Contains the url for the live version of gamefroot.
  * @property ServerURL.LIVE
  * @type string
  * @public
  * @readOnly
  * @static
  */
  LIVE: &#x27;http://198.206.133.200:8081/api/&#x27;,

  /**
  * Contains the url for the debug (also known as staging) version of gamefroot.
  * @property ServerURL.DEBUG
  * @type string
  * @public
  * @readOnly
  * @static
  */
  DEBUG: &#x27;http://staging.gamefroot.com:8081/api/&#x27;

};


/**
* Indicates if the API is ready to make a request or not. 
* This would only ever be &#x27;false&#x27; if we are midway through another API call.
* This is READ ONLY.
* 
* @property ready
* @type boolean
* @readOnly
* @public
*/
Object.defineProperty( Kiwi.Plugins.SocialConnect.Facebook.prototype, &quot;ready&quot;, {
    
    get: function () {
        return this._ready;
    },
    
    enumerable: true,
    
    configurable: true

});


/**
* Indicates if the user is logged in or not.
* Maintains its values from the login and logout methods on this class, 
* so it is not an accurate representation. 
* READ ONLY.
*  
* @property loggedIn
* @type boolean
* @readOnly
* @public
*/
Object.defineProperty( Kiwi.Plugins.SocialConnect.Facebook.prototype, &quot;loggedIn&quot;, {
    
    get: function () {
        return ( this.userInfo !== null );
    },
    
    enumerable: true,
    
    configurable: true

});


/**
* Registers a new gamefroot account. 
* A callback is required to be passed and the first parameter will indicate success.
* 
* @method register
* @param params {Object} The parameters required
*   @param params.username {String} The username that the user would like to use.
*   @param params.password {String} The password the user wants.
*   @param params.email {String} The email of the user.
*   @param params.passwordrepeat {String} Confirmation password. 
*   @param params.callback {Function} Function to be executed when complete.
*   @param [params.context] {Any} Context the callback should be executed in.
* @public
* @return {Boolean} If the API call was made or not.
*/
Kiwi.Plugins.SocialConnect.Gamefroot.prototype.register = function( params ) {

  params = params || {};

  if( !params.callback ) {
    this.log( &#x27;a callback needs to be passed in-order to function correctly.&#x27;, 2 );
    return false;
  }

  if( !params.username || !params.password || !params.email || !params.passwordrepeat ) {
    this.log( &#x27;not all of the needed parameters have been passed.&#x27;, 2 );
    return false;
  };

  var data = {
    &#x27;usrn&#x27;: params.username,
    &#x27;psw&#x27;: params.password,
    &#x27;email&#x27;: params.email,
    &#x27;repsw&#x27;: params.passwordrepeat
  };

  return this._apiRequest( &#x27;account/register&#x27;, data, function( type, data ) {

    //If there was an error.
    if( type == 2 ) {
      params.callback.call( params.context, false, data );

    } else if( data.result == &quot;success&quot; ) {
      params.callback.call( params.context, true, data );
    
    } else {
      params.callback.call( params.context, false, data );
    
    }

  }, true);
;
};


/**
* Login using a gamefroot account. Does not include facebook login functionality. 
* A callback is required to be passed and the first parameter will indicate success.
* 
* @method login
* @param params {Object} The parameters required
*   @param params.username {String} The username that the user would like to use.
*   @param params.password {String} The password the user wants.
*   @param params.callback {Function} Function to be executed when complete.
*   @param [params.context] {Any} Context the callback should be executed in.
* @public
* @return {Boolean} If the API call was made or not.
*/
Kiwi.Plugins.SocialConnect.Gamefroot.prototype._login = function( params ) {

  if( !params.callback ) {
    this.log( &#x27;a callback needs to be passed in-order to function correctly.&#x27;, 2 );
    return false;
  }

  if( !params.username || !params.password ) {
    this.log( &#x27;not all of the needed parameters have been passed.&#x27;, 2 );
    return false;
  };

  var data = {
      &#x27;usrn&#x27;: params.username,
      &#x27;psw&#x27;: params.password,
      &#x27;ref&#x27;: this.game.stage.name
  };
  var that = this;

  return this._apiRequest( &#x27;account/login&#x27;, data, function( type, data ) {

    //If there was an error.
    if( type == 2 ) {
      params.callback.call( params.context, false, data );

    } else if( data.result) {
      if( data.result == &#x27;fail&#x27; ) {
        params.callback.call( params.context, false, data );

      } else {
        that.userInfo = data;
        params.callback.call( params.context, true, data);
      }
   

    } else {
      params.callback.call( params.context, false, data );
    
    }

  }, true);

};


/**
* Login to gamefroot using facebook. 
* A callback is required to be passed and the first parameter will indicate success.
* 
* @method loginWithFB
* @param params {Object} The parameters required
*   @param params.callback {Function} Function to be executed when complete.
*   @param [params.context] {Any} Context the callback should be executed in.
*   @param [params.options.scope] {String} CSV set of information that you app requests from facebook.
* @public
* @return {Boolean} If the API call was made or not.
*/
Kiwi.Plugins.SocialConnect.Gamefroot.prototype.loginWithFB = function( params ) {

  params = params || {};

  if( !params.callback ) {
    this.log( &#x27;a callback needs to be passed in-order to function correctly.&#x27;, 2 );
    return false;
  }

  return this.game.social.facebook.loginApproved( { 

    context: this,

    callback: function( approved ) {

      if( approved ) {
        this._fbRetrieveUserData( params );

      } else {

        this.game.social.facebook.login( { 
          context: this, 
          options: params.options,
          
          callback: function( success ) {

            if( !success ) {
              params.callback.call( params.context, false, &#x27;not logged into facebook.&#x27; );
              return;
            }

            //Get the users information
            this._fbRetrieveUserData( params );

          } 

        } ); //login end.

      } //endif.

    } //loginApproved callback.

  } ); // loginApproved end.

};


/**
* Contains the second steps code in logging into gamefroot using facebook. 
* Handles getting the users information.
* 
* @method _fbRetrieveUserData
* @param params {Object} Parameters from the first step.
* @private
*/
Kiwi.Plugins.SocialConnect.Gamefroot.prototype._fbRetrieveUserData = function( params ) {

  //Get the users information off facebook, and send that to gf
  var success = this.game.social.facebook.me( { 
    context: this,
    callback: function( resp ) {

      //Login to GF using that information..
      this._fbLoginToGF( resp, params );

    }
  } );

  if( !success ) {
    params.callback.call( params.context, false, &#x27;error with getting information from facebook.&#x27;);
  }

};


/**
* Final step in logging into gamefroot using facebook.
* Contains the code communicating to gamefroot, which then creates its account.
* 
* @method _fbLoginToGF
* @param resp {Object} The users information as retrieved by facebook.
* @param params {Object} Parameters from the first step.
* @private
*/
Kiwi.Plugins.SocialConnect.Gamefroot.prototype._fbLoginToGF = function( resp, params ) {

  var data = {
      &quot;type&quot;: &#x27;fb&#x27;,
      &quot;id&quot;: resp.id,
      &quot;fullRes&quot;: JSON.stringify( resp ),
      &#x27;ref&#x27;: this.game.stage.name
  };
  var that = this;

  return this._apiRequest( &#x27;account/login&#x27;, data, function( type, data ) {

    //If there was an error.
    if( type == 2 ) {
      params.callback.call( params.context, false, data );

    } else if( data.result) {
      if( data.result == &#x27;fail&#x27; ) {
        params.callback.call( params.context, false, data );

      } else {
        that.userInfo = data;
        params.callback.call( params.context, true, data);

      }
   

    } else {
      params.callback.call( params.context, false, data );
    
    }

  }, true);

};


/**
* Logs a user out of gamefroot. 
* 
* @method logout
* @param params {Object}
*   @param params.callback {Function} Function to be executed when complete.
*   @param [params.context] {Any} Context the callback should be executed in.
* @public
*/
Kiwi.Plugins.SocialConnect.Gamefroot.prototype.logout = function( params ) {

  params = params || {};

  //Attempt to logout
  return this._apiRequest( &#x27;account/logout&#x27;, {}, function( type, data ) {

    that.userInfo = null;

    //If there was an error.
    if( type == 2 ) {
      if( params.callback ) {
        params.callback.call( params.context, false, data );
      }

    } 

    if( params.callback ) { 
      params.callback.call( params.context, true, data );
    }

  }, true);

};


/**
* Makes a request to the gamefroot servers. 
* Because it is done using XHR requests, it is recommended that do not make multiple requests at once.
* 
* @method _apiRequest
* @param url {String} The URL of the request that is being made.
* @param rawdata {Object} The data to be sent to gf.
* @param callback {Function} The callback to run when complete.
* @param post {Boolean} If information sent should use POST. Majority of methods do anyway.
* @public
* @return {Boolean} If the request was made or not.
*/
Kiwi.Plugins.SocialConnect.Gamefroot.prototype._apiRequest = function( url, rawdata, callback, post ) {

  if( !this._ready ) {
    this.log( &#x27;not ready to make another request yet.&#x27;, 2  );
    return false;
  }

  var method, data, xhr,
    that = this;

  if( post ) {
    method = &#x27;POST&#x27;;
  } else {
    method = &#x27;GET&#x27;; 
  }

  //Stringify the data
  data = null;
  for( var index in rawdata ) {
      if( data === null ) {
          data  = index + &#x27;=&#x27; + encodeURIComponent( rawdata[index] );
      } else {
          data += &#x27;&amp;&#x27; + index + &#x27;=&#x27; + encodeURIComponent( rawdata[index] );
      }
  }

  //Create the XHR request
  xhr = new XMLHttpRequest();
  xhr.open( method, this.serverURL + url, true );
  
  //Create request
  if( post ) {
      xhr.setRequestHeader( &quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot; );
  } 

  xhr.timeout = this.timeout;

  //Events.
  xhr.ontimeout = function() {
    that._error( &#x27;request has timed out.&#x27;, callback );
  };

  xhr.onabort = function() {
    that._error( &#x27;request was aborted.&#x27;, callback );
  };
  
  xhr.onerror = function() {
    that._error( &#x27;request encountered an error.&#x27;, callback );
  };

  xhr.onreadystatechange =  function( event ) {

    if( event.target.readyState !== 4 ) return;
   
    if( xhr.response ) {
      var data = JSON.parse( xhr.response );
    } else {
      var data = {};
    }

    that._ready = true;
    callback.call( this, 1, data );

  };

  //Start.
  xhr.send( data );
  this._ready = false;
  return true;
};


/**
* Executed when a API call has failed. 
* @method _error
* @param errorMsg {String} The error message to show. 
* @param callback {Function} The callback to execute.
* @private
*/
Kiwi.Plugins.SocialConnect.Gamefroot.prototype._error = function( errorMsg, callback ) {

  this._ready = true;
  this.log( errorMsg, 2 );
  callback.call( this, 2, errorMsg );

};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
